<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Coyote Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3); }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }
        .card-pattern { background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.05) 1px, transparent 0); background-size: 12px 12px; }
        .bg-mesh { background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%); }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            opacity: 0;
            animation: confetti-fall 4s ease-in infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .drum-container {
            mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
        }

        .responsive-call {
            font-size: clamp(5rem, 20vw, 9rem);
            line-height: 1;
        }

        .deck-card {
            position: absolute;
            transition: all 0.3s ease;
        }
        
        .vertical-text {
            writing-mode: vertical-rl;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 overflow-hidden fixed inset-0 bg-mesh">
    <div id="root" class="h-full w-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.FB = { auth, db, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, signInWithCustomToken, signInAnonymously, onAuthStateChanged };
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />,
                eyeOff: <><path d="M9.88 9.88 3.59 3.59"/><path d="M2 12s3-7 10-7a7.14 7.14 0 0 1 3.49.93"/><path d="M15.91 15.91A8.13 8.13 0 0 1 12 17c-7 0-10-7-10-7a22.77 22.77 0 0 1 1.71-2.09"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a21.72 21.72 0 0 1-2.26 2.74"/><path d="M17.05 11.45a3 3 0 0 0-4.19-4.19"/><path d="m3 3 18 18"/></>,
                eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
                trophy: <><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>,
                bot: <><rect width="18" height="10" x="3" y="11" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" x2="8" y1="16" y2="16"/><line x1="16" x2="16" y1="16" y2="16"/></>,
                logout: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
                user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                play: <polygon points="5 3 19 12 5 21 5 3" />,
                layers: <><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const DeckStack = ({ count }) => {
            const visibleCards = Math.min(Math.ceil(count / 3), 10);
            return (
                <div className="relative w-12 h-16 md:w-16 md:h-20 bg-indigo-900/20 rounded-lg flex items-center justify-center border border-white/5">
                    {[...Array(visibleCards)].map((_, i) => (
                        <div 
                            key={i} 
                            className="deck-card w-full h-full bg-indigo-700 rounded-lg border border-white/10 card-shadow"
                            style={{ 
                                transform: `translateY(-${i * 1.5}px) translateX(${i * 0.5}px)`,
                                zIndex: i
                            }}
                        >
                            <div className="absolute inset-0 card-pattern opacity-20"></div>
                            {i === visibleCards - 1 && (
                                <div className="absolute inset-0 flex items-center justify-center font-black text-[10px] md:text-xs text-white/80">
                                    {count}
                                </div>
                            )}
                        </div>
                    ))}
                    {count === 0 && <span className="text-[10px] font-black text-white/20 uppercase tracking-tighter">EMPTY</span>}
                </div>
            );
        };

        const ConfettiEffect = () => {
            const items = useMemo(() => Array.from({ length: 50 }).map((_, i) => ({
                id: i, left: Math.random() * 100, delay: Math.random() * 4,
                color: ['#f2d74e', '#95c3de', '#ff9a91', '#f2d74e', '#ffffff'][Math.floor(Math.random() * 5)]
            })), []);
            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-[100]">
                    {items.map(item => (
                        <div key={item.id} className="confetti" style={{ 
                            left: `${item.left}%`, animationDelay: `${item.delay}s`, backgroundColor: item.color,
                            width: `${Math.random() * 10 + 5}px`, height: `${Math.random() * 10 + 5}px`
                        }} />
                    ))}
                </div>
            );
        };

        const DrumRollSelector = ({ currentValue, selectedValue, onSelect }) => {
            const containerRef = useRef(null);
            const options = Array.from({ length: 100 }, (_, i) => currentValue + i + 1);

            useEffect(() => {
                const handleScroll = () => {
                    if (!containerRef.current) return;
                    const scrollY = containerRef.current.scrollTop;
                    const index = Math.round(scrollY / 48);
                    if (options[index] !== undefined && options[index] !== selectedValue) {
                        onSelect(options[index]);
                    }
                };
                const ref = containerRef.current;
                ref?.addEventListener('scroll', handleScroll);
                return () => ref?.removeEventListener('scroll', handleScroll);
            }, [options, selectedValue, onSelect]);

            return (
                <div className="relative h-32 w-24 glass-panel rounded-2xl overflow-hidden drum-container flex flex-col items-center border border-indigo-500/30">
                    <div 
                        className="absolute top-0 bottom-0 w-full flex flex-col overflow-y-scroll no-scrollbar snap-y snap-mandatory py-10" 
                        ref={containerRef}
                    >
                        {options.map((val) => (
                            <div
                                key={val}
                                className={`snap-center h-12 w-full flex-shrink-0 flex items-center justify-center text-xl font-black transition-all ${
                                    selectedValue === val ? "text-indigo-400 scale-125" : "text-white/20"
                                }`}
                            >
                                {val}
                            </div>
                        ))}
                    </div>
                    <div className="absolute inset-0 pointer-events-none border-y-2 border-indigo-500/50 h-10 my-auto"></div>
                </div>
            );
        };

        const Card = ({ card, revealed, isMe, isSpectator }) => {
            if (!card) return null;
            const shouldReveal = revealed || isSpectator;
            
            const getCardStyle = () => {
                if (!shouldReveal) return "bg-indigo-700";
                if (card.type === 'x2') return "bg-purple-600";
                if (card.type === 'max0') return "bg-cyan-600";
                if (card.type === '?') return "bg-pink-600";
                if (card.type === 'night') return "bg-slate-900 border-indigo-400";
                if (card.value > 10) return "bg-orange-600";
                if (card.value > 0) return "bg-amber-500";
                if (card.value === 0) return "bg-slate-500";
                return "bg-red-600";
            };

            const getDisplayName = () => {
                if (card.type === 'x2') return '酋長カード(×2)';
                if (card.type === 'max0') return 'キツネカード(MAX→0)';
                if (card.type === '?') return 'ほらあなカード(?)';
                if (card.type === 'night') return '夜カード(シャッフル 0)';
                if (card.value < 0) return '兵隊カード';
                if (card.value === 0) return 'おばけカード';
                return 'コヨーテカード';
            };

            return (
                <div className={`relative w-20 h-32 md:w-24 md:h-36 rounded-xl transition-all duration-500 transform ${getCardStyle()} card-shadow overflow-hidden flex flex-col items-center justify-center border-2 ${isSpectator && !revealed ? 'border-yellow-400/50' : 'border-white/20'}`}>
                    <div className="absolute inset-0 card-pattern opacity-30"></div>
                    {!shouldReveal ? (
                        <div className="flex flex-col items-center justify-center text-white/40">
                            <Icon name="zap" className="w-8 h-8 md:w-10 md:h-10 mb-1" />
                            <span className="text-[10px] font-black tracking-tighter uppercase italic text-center">COYOTE</span>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center text-white z-10 text-center px-1">
                            {isSpectator && !revealed && <div className="absolute top-1 left-1 opacity-50"><Icon name="eye" className="w-3 h-3 text-yellow-400" /></div>}
                            <span className={`font-black italic tracking-tighter leading-none ${card.type ? 'text-xl' : 'text-3xl md:text-4xl'}`}>
                                {card.type === 'x2' ? '×2' : (card.type === 'max0' ? 'MAX0' : (card.type === '?' ? '?' : (card.type === 'night' ? '0' : card.value)))}
                            </span>
                            <div className="mt-1 h-0.5 w-8 bg-white/30 rounded-full"></div>
                            <span className="text-[8px] font-bold mt-1 uppercase opacity-70 tracking-tighter leading-tight">
                                {getDisplayName()}
                            </span>
                        </div>
                    )}
                    {isMe && !revealed && !isSpectator && (
                        <div className="absolute inset-0 bg-black/40 backdrop-blur-[1px] flex items-center justify-center">
                            <Icon name="eyeOff" className="w-5 h-5 text-white/50" />
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [loading, setLoading] = useState(true);
            const [playerName, setPlayerName] = useState(localStorage.getItem('coyote_name') || '');
            const [roomIdInput, setRoomIdInput] = useState('');
            const [error, setError] = useState('');
            const [localSelectedValue, setLocalSelectedValue] = useState(1);
            const [maxPlayers, setMaxPlayers] = useState(4);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'coyote-pro-v2';

            const cpuNames = ["ロボ太郎", "AI次郎", "電脳三郎", "計算四郎", "メカ五郎", "サイバー六郎"];

            // 認証ロジックの安定化
            useEffect(() => {
                let mounted = true;
                const initAuth = async () => {
                    if (!window.FB) return;
                    const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.FB;
                    
                    const unsubscribe = onAuthStateChanged(auth, (u) => {
                        if (u && mounted) {
                            setUser(u);
                            setLoading(false);
                        }
                    });

                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else if (!auth.currentUser) {
                            await signInAnonymously(auth);
                        } else if (mounted) {
                            setUser(auth.currentUser);
                            setLoading(false);
                        }
                    } catch (err) {
                        console.error("Auth error:", err);
                        if (mounted) {
                            setError("認証エラーが発生しました。");
                            setLoading(false);
                        }
                    }

                    return unsubscribe;
                };

                const timer = setTimeout(() => {
                    if (window.FB) initAuth();
                    else window.addEventListener('firebase-ready', initAuth, { once: true });
                }, 100);

                return () => {
                    mounted = false;
                    clearTimeout(timer);
                };
            }, []);

            useEffect(() => {
                if (!user || !room?.id) return;
                const { db, doc, onSnapshot } = window.FB;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id);
                const unsubscribe = onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setRoom({ id: snap.id, ...data });
                        if (data.status === 'playing') {
                            setLocalSelectedValue(prev => Math.max(prev, data.currentValue + 1));
                        }
                    } else setRoom(null);
                }, (err) => setError("同期エラー"));
                return () => unsubscribe();
            }, [user, room?.id]);

            const generateDeck = () => {
                const deck = [];
                const coyote = [
                    { v: 1, c: 1 }, { v: 2, c: 4 }, { v: 3, c: 4 }, { v: 4, c: 4 }, 
                    { v: 5, c: 4 }, { v: 10, c: 3 }, { v: 15, c: 2 }, { v: 20, c: 1 }
                ];
                const ghost = [{ v: 0, c: 3 }];
                const soldier = [{ v: -5, c: 2 }, { v: -10, c: 1 }];
                const special = [
                    { t: 'night', v: 0, c: 1 },
                    { t: 'x2', v: 0, c: 1 },
                    { t: 'max0', v: 0, c: 1 },
                    { t: '?', v: 0, c: 1 }
                ];

                [...coyote, ...ghost, ...soldier, ...special].forEach(d => { 
                    for(let i=0; i<d.c; i++) {
                        deck.push({ 
                            value: d.v, 
                            type: d.t || null, 
                            id: Math.random().toString(36).substr(2, 9) 
                        });
                    }
                });
                return deck.sort(() => Math.random() - 0.5);
            };

            const calculateTotal = (players, deck) => {
                let cards = players.filter(p => p.hp > 0).map(p => p.currentCard).filter(Boolean);
                let finalCards = [...cards];
                
                const qIdx = finalCards.findIndex(c => c.type === '?');
                let resolvedQ = null;
                if (qIdx !== -1 && deck.length > 0) {
                    resolvedQ = deck[0];
                    finalCards[qIdx] = resolvedQ;
                }
                
                const hasMax0 = finalCards.some(c => c.type === 'max0');
                let values = finalCards.map(c => c.value || 0);
                if (hasMax0) {
                    const maxVal = Math.max(...values);
                    const maxIdx = values.indexOf(maxVal);
                    if (maxIdx !== -1) values[maxIdx] = 0;
                }
                
                let sum = values.reduce((a, b) => a + b, 0);
                
                const hasX2 = finalCards.some(c => c.type === 'x2');
                if (hasX2) sum *= 2;
                
                return { sum, cards: finalCards, resolvedQ };
            };

            const createRoom = async (isSolo = false) => {
                if (!user || !playerName.trim()) return setError("名前を入力してください");
                const rid = Math.floor(100000 + Math.random() * 899999).toString();
                
                let initialPlayers = [{ uid: user.uid, name: playerName, hp: 3, isCPU: false }];
                
                if (isSolo) {
                    for (let i = 0; i < maxPlayers - 1; i++) {
                        initialPlayers.push({
                            uid: `cpu_${Math.random().toString(36).substr(2, 5)}`,
                            name: cpuNames[i % cpuNames.length],
                            hp: 3, isCPU: true, personality: Math.random() > 0.5 ? 'aggressive' : 'cautious'
                        });
                    }
                }

                const newRoom = {
                    hostId: user.uid, 
                    status: isSolo ? 'playing' : 'waiting',
                    maxPlayers: maxPlayers,
                    players: initialPlayers,
                    deck: generateDeck(), 
                    currentValue: 0, 
                    currentTurn: 0, 
                    lastResult: null
                };

                if (isSolo) {
                    const tempDeck = [...newRoom.deck];
                    newRoom.players = newRoom.players.map(p => ({ ...p, currentCard: tempDeck.pop() }));
                    newRoom.deck = tempDeck;
                }

                localStorage.setItem('coyote_name', playerName);
                await window.FB.setDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', rid), newRoom);
                setRoom({ id: rid, ...newRoom });
            };

            const joinRoom = async () => {
                const rid = roomIdInput.trim();
                if (!user || !rid || !playerName.trim()) return;
                try {
                    const snap = await window.FB.getDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', rid));
                    if (!snap.exists()) return setError("部屋が見つかりません");
                    const data = snap.data();
                    let players = [...data.players];
                    if (!players.find(p => p.uid === user.uid)) {
                        if (players.length >= data.maxPlayers) return setError("満員です");
                        players.push({ uid: user.uid, name: playerName, hp: data.status === 'waiting' ? 3 : 0, isCPU: false });
                    }
                    await window.FB.updateDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { players });
                    setRoom({ id: rid, ...data, players });
                } catch (e) { setError("参加失敗"); }
            };

            const addCPU = async () => {
                if (!room || room.players.length >= room.maxPlayers) return;
                const newPlayers = [...room.players, {
                    uid: `cpu_${Math.random().toString(36).substr(2, 5)}`,
                    name: cpuNames[room.players.length % cpuNames.length],
                    hp: 3, isCPU: true, personality: Math.random() > 0.5 ? 'aggressive' : 'cautious'
                }];
                await window.FB.updateDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), { players: newPlayers });
            };

            const handleAction = async (isCoyote) => {
                if (!room || !user) return;
                const { db, doc, updateDoc } = window.FB;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id);
                
                if (isCoyote) {
                    const { sum, resolvedQ } = calculateTotal(room.players, room.deck);
                    const playersWithHp = room.players.map((p, i) => i).filter(idx => room.players[idx].hp > 0);
                    const myIdxInAlive = playersWithHp.indexOf(room.currentTurn);
                    const prevTurn = playersWithHp[(myIdxInAlive - 1 + playersWithHp.length) % playersWithHp.length];
                    
                    const loserIdx = room.currentValue > sum ? prevTurn : room.currentTurn;
                    const updatedPlayers = room.players.map((p, i) => i === loserIdx ? { ...p, hp: p.hp - 1 } : p);
                    const aliveCount = updatedPlayers.filter(p => p.hp > 0).length;

                    const hasNight = room.players.some(p => p.currentCard?.type === 'night');

                    let updatedDeck = [...room.deck];
                    if (resolvedQ) updatedDeck.shift();

                    await updateDoc(roomRef, {
                        status: 'result',
                        players: updatedPlayers,
                        deck: updatedDeck,
                        lastResult: { 
                            sum, 
                            call: room.currentValue,
                            isOver: room.currentValue > sum,
                            loser: room.players[loserIdx].name,
                            resolvedQ: resolvedQ,
                            requiresReshuffle: hasNight,
                            isGameOver: aliveCount === 1
                        }
                    });
                } else {
                    await updateDoc(roomRef, {
                        currentValue: localSelectedValue,
                        currentTurn: findNextTurn(room.players, room.currentTurn)
                    });
                }
            };

            const findNextTurn = (players, current) => {
                let next = (current + 1) % players.length;
                while (players[next].hp <= 0) next = (next + 1) % players.length;
                return next;
            };

            const startGame = async () => {
                let deck;
                if (room.lastResult?.requiresReshuffle || !room.deck || room.deck.length < room.players.length) {
                    deck = generateDeck();
                } else {
                    deck = [...room.deck];
                }

                const players = room.players.map(p => ({ ...p, currentCard: p.hp > 0 ? deck.pop() : null }));
                await window.FB.updateDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                    status: 'playing', players, deck, currentValue: 0, currentTurn: room.players.findIndex(p => p.hp > 0), lastResult: null
                });
            };

            const finishGame = async () => {
                await window.FB.updateDoc(window.FB.doc(window.FB.db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                    status: 'finished'
                });
            };

            useEffect(() => {
                if (room?.status === 'playing' && room.players[room.currentTurn]?.isCPU && room.hostId === user?.uid) {
                    const timer = setTimeout(() => {
                        const cpu = room.players[room.currentTurn];
                        const othersCards = room.players.filter((p, i) => i !== room.currentTurn && p.hp > 0).map(p => p.currentCard);
                        const visibleSum = othersCards.reduce((a, b) => a + (b?.value || 0), 0);
                        const threshold = visibleSum + (cpu.personality === 'aggressive' ? 12 : 4);
                        if (room.currentValue >= threshold) handleAction(true);
                        else {
                            setLocalSelectedValue(room.currentValue + 1);
                            handleAction(false);
                        }
                    }, 2500);
                    return () => clearTimeout(timer);
                }
            }, [room?.currentTurn, room?.status, user]);

            if (loading) return <div className="h-full flex flex-col items-center justify-center text-indigo-500 font-bold animate-pulse"><div className="mb-4">AUTHENTICATING...</div><div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>;

            if (error && !user) return <div className="h-full flex items-center justify-center text-red-500 font-bold p-10 text-center">{error}</div>;

            if (!room) return (
                <div className="h-full flex flex-col items-center justify-center p-6 overflow-y-auto no-scrollbar">
                    <div className="text-center mb-8 shrink-0">
                        <h1 className="text-6xl md:text-7xl font-black italic text-white tracking-tighter float drop-shadow-2xl">COYOTE</h1>
                        <p className="text-indigo-400 font-bold tracking-widest uppercase text-xs mt-2 opacity-80 underline decoration-indigo-500 decoration-2 underline-offset-4">Online Pro Edition</p>
                    </div>

                    <div className="w-full max-sm space-y-4">
                        <div className="glass-panel p-6 rounded-[2rem] border border-white/10">
                            <div className="space-y-6">
                                <div>
                                    <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest block mb-2 px-1">PLAYER NAME</label>
                                    <input 
                                        className="w-full bg-slate-900/50 border-2 border-slate-800 p-4 rounded-2xl text-center text-white font-bold focus:border-indigo-500 outline-none transition-all" 
                                        placeholder="プレイヤー名を入力" 
                                        value={playerName} 
                                        onChange={e => setPlayerName(e.target.value)} 
                                    />
                                </div>

                                <div>
                                    <div className="flex justify-between items-center px-1 mb-2">
                                        <label className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">PLAYERS</label>
                                        <span className="text-sm font-black text-white">{maxPlayers} Players</span>
                                    </div>
                                    <div className="flex items-center gap-4 bg-slate-900/50 p-4 rounded-2xl border-2 border-slate-800">
                                        <button onClick={() => setMaxPlayers(p => Math.max(2, p - 1))} className="text-indigo-400 hover:text-white"><Icon name="logout" className="rotate-180" /></button>
                                        <input 
                                            type="range" min="2" max="6" step="1" 
                                            className="flex-grow accent-indigo-500 h-1" 
                                            value={maxPlayers} 
                                            onChange={e => setMaxPlayers(parseInt(e.target.value))} 
                                        />
                                        <button onClick={() => setMaxPlayers(p => Math.min(6, p + 1))} className="text-indigo-400 hover:text-white"><Icon name="logout" /></button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={() => createRoom(true)} 
                                        className="flex flex-col items-center justify-center p-4 bg-indigo-600 rounded-2xl font-black text-white hover:bg-indigo-500 active:scale-95 transition-all gap-2"
                                    >
                                        <Icon name="bot" />
                                        <span className="text-xs">一人で遊ぶ</span>
                                    </button>
                                    <button 
                                        onClick={() => createRoom(false)} 
                                        className="flex flex-col items-center justify-center p-4 bg-slate-800 rounded-2xl font-black text-white hover:bg-slate-700 active:scale-95 transition-all gap-2"
                                    >
                                        <Icon name="user" />
                                        <span className="text-xs">部屋を作る</span>
                                    </button>
                                </div>
                            </div>

                            <div className="flex items-center my-6 gap-3">
                                <div className="h-px bg-white/5 flex-grow"></div>
                                <span className="text-[10px] text-white/20 font-bold uppercase tracking-widest">OR JOIN ROOM</span>
                                <div className="h-px bg-white/5 flex-grow"></div>
                            </div>

                            <div className="flex gap-2">
                                <input 
                                    className="flex-grow bg-slate-900/50 border-2 border-slate-800 p-4 rounded-2xl text-center text-white font-bold outline-none focus:border-emerald-500 transition-all" 
                                    placeholder="部屋番号を入力" 
                                    value={roomIdInput} 
                                    onChange={e => setRoomIdInput(e.target.value)} 
                                />
                                <button 
                                    onClick={joinRoom} 
                                    className="px-6 bg-emerald-600 rounded-2xl font-black text-white hover:bg-emerald-500 active:scale-95 transition-all"
                                >
                                    参加
                                </button>
                            </div>

                            {error && <p className="text-red-400 text-[10px] mt-4 text-center font-bold animate-pulse">{error}</p>}
                        </div>
                    </div>
                </div>
            );

            if (room.status === 'finished') {
                const winner = room.players.find(p => p.hp > 0);
                return (
                    <div className="h-full flex flex-col items-center justify-center relative bg-slate-950">
                        <ConfettiEffect />
                        <div className="text-center animate-bounce">
                            <Icon name="trophy" className="w-24 h-24 text-yellow-500 mx-auto mb-6" />
                            <h2 className="text-4xl font-black text-yellow-500 uppercase tracking-widest mb-2">Champion</h2>
                            <div className="text-7xl font-black italic text-white tracking-tighter">{winner?.name}</div>
                        </div>
                        <button onClick={() => setRoom(null)} className="mt-12 bg-slate-800 text-white px-10 py-4 rounded-full font-black hover:bg-slate-700 active:scale-95 transition-all">EXIT TO MENU</button>
                    </div>
                );
            }

            const me = room.players.find(p => p.uid === user.uid);
            const isSpectator = me?.hp === 0;

            return (
                <div className="h-full flex flex-col">
                    <header className="p-4 flex justify-between items-center glass-panel border-b border-white/5 z-50">
                        <div className="flex items-center gap-4">
                            <div className="flex flex-col">
                                <span className="text-[10px] text-indigo-400 font-black tracking-widest uppercase leading-none mb-1">Room ID</span>
                                <span className="font-black text-xl tracking-tighter text-white leading-none">{room.id}</span>
                            </div>
                            <div className="h-8 w-px bg-white/10 hidden md:block"></div>
                            <div className="hidden md:flex flex-col">
                                <span className="text-[10px] text-slate-500 font-black tracking-widest uppercase leading-none mb-1">Deck</span>
                                <span className="font-black text-sm text-white flex items-center gap-1">
                                    <Icon name="layers" className="w-3 h-3 text-indigo-400" />
                                    {room.deck?.length || 0} left
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 items-center">
                            {isSpectator && (
                                <div className="flex items-center gap-2 bg-yellow-500/20 text-yellow-400 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-yellow-500/30">
                                    <Icon name="eye" className="w-3 h-3" /> Spectating
                                </div>
                            )}
                            {room.status === 'waiting' && room.hostId === user.uid && room.players.length < room.maxPlayers && (
                                <button onClick={addCPU} className="p-2 bg-slate-800 rounded-xl text-slate-300 active:bg-slate-700"><Icon name="bot" /></button>
                            )}
                            <button onClick={() => setRoom(null)} className="p-2 text-slate-500 hover:text-white active:scale-90"><Icon name="logout" /></button>
                        </div>
                    </header>

                    <main className="flex-grow flex flex-col items-center justify-center p-4 relative overflow-y-auto no-scrollbar">
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 hidden lg:flex flex-col items-center gap-2 opacity-60">
                            <DeckStack count={room.deck?.length || 0} />
                            <span className="text-[8px] font-black text-white/40 tracking-widest uppercase vertical-text mt-4">Draw Pile</span>
                        </div>

                        <div className="text-center mb-6 z-10 w-full px-4">
                            <div className="text-slate-500 font-bold text-[10px] uppercase tracking-[0.4em] mb-1">
                                {room.status === 'result' ? 'RESULT' : 'CURRENT CALL'}
                            </div>
                            
                            <div className={`responsive-call font-black italic transition-all duration-500 ${room.status === 'result' ? 'text-emerald-400 scale-105' : 'text-white'}`}>
                                {room.status === 'result' ? room.lastResult?.sum : room.currentValue}
                            </div>
                            
                            {room.status === 'result' && (
                                <div className="mt-4 flex flex-col items-center gap-2 animate-in fade-in zoom-in duration-300">
                                    {room.lastResult?.resolvedQ && (
                                        <div className="bg-pink-600/20 border border-pink-500/30 px-4 py-1.5 rounded-xl mb-2 flex items-center gap-2 animate-pulse">
                                            <span className="text-[10px] font-black text-pink-400 uppercase tracking-widest">? Card Resolved:</span>
                                            <span className="text-sm font-black text-white">{room.lastResult.resolvedQ.value}</span>
                                        </div>
                                    )}

                                    <div className="flex items-center gap-4">
                                        <div className={`flex flex-col items-center px-4 py-2 rounded-2xl border transition-all ${room.lastResult?.isOver ? 'bg-red-500/10 border-red-500/30 scale-105' : 'bg-white/5 border-white/10'}`}>
                                            <span className="text-[8px] font-black text-indigo-400 tracking-widest uppercase">Declared</span>
                                            <span className={`text-xl font-black ${room.lastResult?.isOver ? 'text-red-400' : 'text-white'}`}>{room.lastResult?.call}</span>
                                        </div>
                                        <div className="text-xl font-black text-white/20 italic">VS</div>
                                        <div className={`flex flex-col items-center px-4 py-2 rounded-2xl border transition-all ${!room.lastResult?.isOver ? 'bg-blue-500/10 border-blue-500/30 scale-105' : 'bg-emerald-500/10 border-emerald-500/20'}`}>
                                            <span className="text-[8px] font-black text-emerald-400 tracking-widest uppercase">Total</span>
                                            <span className="text-xl font-black text-emerald-400">{room.lastResult?.sum}</span>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-4 bg-white/5 border border-white/10 px-6 py-2 rounded-full backdrop-blur-sm">
                                        <span className="text-xs text-white font-black tracking-tight italic">
                                            {room.lastResult?.isOver ? (
                                                <><span className="text-red-400">{room.lastResult?.call}</span> は合計を超えています！</>
                                            ) : (
                                                <><span className="text-emerald-400">{room.lastResult?.call}</span> はセーフでした！</>
                                            )}
                                        </span>
                                    </div>

                                    {room.lastResult?.requiresReshuffle && (
                                        <div className="mt-2 bg-indigo-500/20 border border-indigo-500/40 px-6 py-1.5 rounded-full flex items-center gap-2">
                                            <Icon name="zap" className="w-3 h-3 text-indigo-400" />
                                            <span className="text-[10px] text-white font-black tracking-widest uppercase">夜カード発動: リシャッフルされます</span>
                                        </div>
                                    )}

                                    <div className="mt-2 bg-red-500/20 border border-red-500/40 px-6 py-2 rounded-full animate-bounce">
                                        <span className="text-sm text-white font-black tracking-tight italic uppercase">
                                            <span className="text-red-400">{room.lastResult?.loser}</span> GETS DAMAGE!
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex flex-wrap justify-center gap-4 md:gap-6 w-full max-w-5xl px-4 pb-12">
                            {room.players.map((p, i) => {
                                const isMe = p.uid === user.uid;
                                const isTurn = room.currentTurn === i && room.status === 'playing';
                                const revealed = room.status === 'result' || (room.status === 'playing' && !isMe);
                                return (
                                    <div key={p.uid} className={`flex flex-col items-center gap-3 transition-all duration-500 ${isTurn ? 'scale-110 z-20' : 'opacity-70 scale-90'} ${p.hp <= 0 ? 'grayscale brightness-50' : ''}`}>
                                        <div className="relative">
                                            <Card card={p.currentCard} revealed={revealed} isMe={isMe} isSpectator={isSpectator} />
                                            {isTurn && <div className="absolute -inset-4 border-2 border-indigo-500 rounded-2xl animate-pulse"></div>}
                                            {room.status === 'result' && room.lastResult?.loser === p.name && (
                                                <div className="absolute -top-2 -right-2 bg-red-600 text-white p-1 rounded-full animate-ping z-30">
                                                    <Icon name="zap" className="w-4 h-4" />
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-col items-center gap-1.5 w-full">
                                            <div className={`px-3 py-1 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-1.5 whitespace-nowrap ${isTurn ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-slate-800 text-slate-400'}`}>
                                                {p.isCPU && <Icon name="bot" className="w-3 h-3" />} {p.name}
                                            </div>
                                            <div className="flex gap-1">
                                                {[...Array(3)].map((_, j) => (
                                                    <div key={j} className={`w-3.5 h-3.5 rounded-full flex items-center justify-center transition-all ${j < p.hp ? 'bg-red-500 shadow-sm' : 'bg-slate-800/50'}`}>
                                                        {j < p.hp && <Icon name="heart" className="w-2 h-2 text-white fill-white" />}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {room.status === 'waiting' && room.hostId === user.uid && (
                            <div className="flex flex-col items-center gap-4">
                                <button onClick={startGame} className="bg-white text-slate-950 px-16 py-5 rounded-full font-black text-2xl hover:scale-105 shadow-xl transition-transform flex items-center gap-3 active:scale-95">
                                    <Icon name="play" className="fill-current w-6 h-6" /> START GAME
                                </button>
                                <p className="text-[10px] text-white/40 font-bold uppercase tracking-widest">
                                    Players: {room.players.length} / {room.maxPlayers}
                                </p>
                            </div>
                        )}
                        
                        {room.status === 'result' && room.hostId === user.uid && (
                            <div className="flex flex-col items-center gap-4 z-50">
                                {room.lastResult?.isGameOver ? (
                                    <button 
                                        onClick={finishGame} 
                                        className="bg-yellow-500 text-slate-950 px-16 py-5 rounded-full font-black text-2xl hover:scale-105 shadow-xl transition-all flex items-center gap-3 active:scale-95 animate-bounce"
                                    >
                                        <Icon name="trophy" className="fill-current w-6 h-6" /> 優勝者を確認
                                    </button>
                                ) : (
                                    <button 
                                        onClick={startGame} 
                                        className="bg-emerald-500 text-white px-12 py-4 rounded-full font-black text-xl hover:scale-105 transition-transform active:scale-95 shadow-xl shadow-emerald-500/20"
                                    >
                                        NEXT ROUND
                                    </button>
                                )}
                            </div>
                        )}
                    </main>

                    {room.status === 'playing' && room.players[room.currentTurn]?.uid === user.uid && (
                        <footer className="p-6 glass-panel border-t border-white/5 flex flex-col items-center gap-6 z-50">
                            <div className="flex flex-col md:flex-row items-center gap-6 w-full max-w-lg">
                                <button onClick={() => handleAction(true)} className="w-full md:w-1/3 py-6 bg-red-600 rounded-3xl font-black text-xl shadow-xl active:scale-95 transition-all order-2 md:order-1 flex items-center justify-center gap-2">
                                    <Icon name="zap" /> COYOTE!
                                </button>
                                <div className="flex items-center gap-4 w-full md:w-2/3 order-1 md:order-2">
                                    <DrumRollSelector currentValue={room.currentValue} selectedValue={localSelectedValue} onSelect={setLocalSelectedValue} />
                                    <button onClick={() => handleAction(false)} className="flex-grow py-6 bg-indigo-600 rounded-3xl font-black text-xl shadow-xl active:scale-95 transition-all flex flex-col items-center leading-none">
                                        <span className="mb-1">RAISE</span>
                                        <span className="opacity-70 font-black tracking-[0.1em] text-sm">TO {localSelectedValue}</span>
                                    </button>
                                </div>
                            </div>
                        </footer>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>