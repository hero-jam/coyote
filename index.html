<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Coyote Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }
        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .celebrate-anim { animation: celebrate 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 overflow-hidden fixed inset-0">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } = window.firebase;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'online-coyote-pro-v1';

        const DECK_DEFINITION = [
            { value: 20, count: 1, color: '#92400e' },
            { value: 15, count: 2, color: '#b45309' },
            { value: 10, count: 3, color: '#d97706' },
            { value: 5, count: 4, color: '#f59e0b' },
            { value: 4, count: 4, color: '#fbbf24' },
            { value: 3, count: 4, color: '#fbbf24' },
            { value: 2, count: 4, color: '#fbbf24' },
            { value: 1, count: 4, color: '#fbbf24' },
            { value: 0, count: 3, color: '#94a3b8' },
            { value: -5, count: 2, color: '#f87171' },
            { value: -10, count: 1, color: '#ef4444' },
            { type: 'x2', count: 1, color: '#8b5cf6' },
            { type: 'max0', count: 1, color: '#06b6d4' },
            { type: '?', count: 1, color: '#ec4899' },
            { type: 'night', count: 1, color: '#1e293b' }
        ];

        const generateDeck = () => {
            const deck = [];
            DECK_DEFINITION.forEach(item => {
                for (let i = 0; i < item.count; i++) {
                    deck.push({ ...item, id: Math.random().toString(36).substr(2, 9) });
                }
            });
            return deck.sort(() => Math.random() - 0.5);
        };

        const calculateTotal = (cards, deck) => {
            let processedCards = [...cards];
            let newDeck = [...deck];
            processedCards = processedCards.map(c => {
                if (c.type === '?') return newDeck.length > 0 ? newDeck.pop() : { value: 0 };
                return c;
            });
            let values = processedCards.map(c => typeof c.value === 'number' ? c.value : 0);
            const specials = processedCards.map(c => c.type);
            if (specials.includes('max0')) {
                const max = Math.max(...values);
                const idx = values.indexOf(max);
                if (idx > -1) values[idx] = 0;
            }
            let total = values.reduce((a, b) => a + b, 0);
            if (specials.includes('x2')) total *= 2;
            return { total, deck: newDeck };
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const Confetti = () => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let frame;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const particles = Array.from({ length: 150 }).map(() => ({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 8 + 4,
                    color: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'][Math.floor(Math.random() * 5)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 6.28,
                    spin: Math.random() * 0.2 - 0.1
                }));
                const loop = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => {
                        ctx.save();
                        ctx.translate(p.x, p.y);
                        ctx.rotate(p.angle);
                        ctx.fillStyle = p.color;
                        ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                        ctx.restore();
                        p.y += p.speed; p.angle += p.spin;
                        if (p.y > canvas.height) p.y = -20;
                    });
                    frame = requestAnimationFrame(loop);
                };
                loop();
                return () => cancelAnimationFrame(frame);
            }, []);
            return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[400]" />;
        };

        const CoyoteCard = ({ card, revealed, isMe }) => {
            return (
                <div className="w-16 h-24 md:w-24 md:h-36 relative rounded-xl overflow-hidden shadow-2xl transition-all perspective-1000">
                    <div className={`absolute inset-0 bg-white flex flex-col items-center justify-center transition-opacity duration-500 ${revealed ? 'opacity-100' : 'opacity-0'}`} style={{ color: card?.color || '#333' }}>
                        <span className="text-xl md:text-3xl font-black italic">
                            {card?.type === 'x2' ? '×2' : (card?.value ?? card?.type ?? '?')}
                        </span>
                        {card?.type && card.type !== 'x2' && <span className="text-[8px] md:text-[10px] font-bold uppercase mt-1">{card.type}</span>}
                    </div>
                    <div className={`absolute inset-0 bg-indigo-600 flex items-center justify-center transition-opacity duration-500 ${revealed ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="text-indigo-400 font-black text-center leading-tight">
                            <Icon name="zap" size={24} className="mx-auto mb-1 opacity-50" />
                            <div className="text-[8px] tracking-widest">COYOTE</div>
                        </div>
                    </div>
                    {isMe && !revealed && (
                        <div className="absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-[2px]">
                            <Icon name="eye-off" size={16} className="text-white/60" />
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [loading, setLoading] = useState(true);
            const [playerName, setPlayerName] = useState(localStorage.getItem('coyote_name') || 'プレイヤー');
            const [roomIdInput, setRoomIdInput] = useState('');
            const [maxPlayers, setMaxPlayers] = useState(5);
            const [error, setError] = useState('');
            const [showHelp, setShowHelp] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error(e); } finally { setLoading(false); }
                };
                initAuth();
                const unsub = onAuthStateChanged(auth, setUser);
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !room?.id) return;
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), (snap) => {
                    if (snap.exists()) setRoom({ id: snap.id, ...snap.data() });
                }, (err) => console.error(err));
                return () => unsub();
            }, [user, room?.id]);

            const createRoom = async () => {
                if (!user) return;
                const id = Math.floor(100000 + Math.random() * 899999).toString();
                const roomData = {
                    hostId: user.uid,
                    status: 'waiting',
                    maxPlayers: parseInt(maxPlayers),
                    players: [{ uid: user.uid, name: playerName, hp: 3 }],
                    viewers: [],
                    deck: generateDeck(),
                    currentTurn: 0,
                    currentValue: 0
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', id), roomData);
                setRoom({ id, ...roomData });
                localStorage.setItem('coyote_name', playerName);
            };

            const joinRoom = async () => {
                const rid = roomIdInput.trim().toUpperCase();
                if (!rid || !user) return;
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid));
                if (!snap.exists()) return setError('ルームが見つかりません');
                const data = snap.data();
                let players = [...data.players];
                let viewers = [...(data.viewers || [])];
                const existingPlayer = players.find(p => p.uid === user.uid);
                if (existingPlayer) {
                    players = players.map(p => p.uid === user.uid ? {...p, name: playerName} : p);
                } else if (data.status === 'waiting' && players.length < data.maxPlayers) {
                    players.push({ uid: user.uid, name: playerName, hp: 3 });
                } else {
                    if (!viewers.includes(user.uid)) viewers.push(user.uid);
                }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { players, viewers });
                setRoom({ id: rid, ...data, players, viewers });
                localStorage.setItem('coyote_name', playerName);
            };

            const leaveRoom = async () => {
                if (!room || !user) return;
                const rid = room.id;
                const players = room.players.filter(p => p.uid !== user.uid);
                const viewers = (room.viewers || []).filter(v => v !== user.uid);
                
                // If the last person (host) leaves, we could theoretically delete, but for simple app we just disconnect state
                if (players.length > 0) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid), { 
                        players, 
                        viewers,
                        hostId: room.hostId === user.uid ? players[0].uid : room.hostId // Transfer host if host left
                    });
                }
                setRoom(null);
            };

            const startGame = async () => {
                if (!room || room.hostId !== user.uid) return;
                let deck = [...room.deck];
                const activePlayers = room.players.filter(p => p.hp > 0);
                if (deck.length < activePlayers.length) deck = generateDeck();
                const playersWithCards = room.players.map(p => p.hp > 0 ? { ...p, currentCard: deck.pop() } : p);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                    status: 'playing',
                    players: playersWithCards,
                    deck,
                    currentValue: 0,
                    currentTurn: room.players.findIndex(p => p.hp > 0),
                    lastResult: null
                });
            };

            const handleCoyote = async () => {
                if (!room) return;
                const activePlayers = room.players.filter(p => p.hp > 0);
                const cards = activePlayers.map(p => p.currentCard);
                const { total, deck: nextDeck } = calculateTotal(cards, room.deck);
                const prevTurnIdx = (room.currentTurn - 1 + room.players.length) % room.players.length;
                const loserIdx = room.currentValue > total ? prevTurnIdx : room.currentTurn;
                const updatedPlayers = room.players.map((p, i) => i === loserIdx ? { ...p, hp: p.hp - 1 } : p);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                    status: 'result',
                    lastResult: { total, loserName: room.players[loserIdx].name, success: room.currentValue > total },
                    players: updatedPlayers,
                    deck: nextDeck
                });
            };

            const winner = useMemo(() => {
                if (!room) return null;
                const survivors = room.players.filter(p => p.hp > 0);
                return (survivors.length === 1 && room.players.length >= 2) ? survivors[0] : null;
            }, [room]);

            const isSpectator = room?.viewers?.includes(user?.uid) || (room?.status === 'playing' && !room?.players.find(p => p.uid === user?.uid));

            if (loading) return <div className="h-full flex items-center justify-center text-indigo-500 font-black italic">CONNECTING...</div>;

            if (!room) return (
                <div className="h-full flex flex-col items-center p-4 md:p-6 bg-slate-950 overflow-y-auto">
                    <div className="text-center mt-12 mb-10">
                        <h1 className="text-6xl md:text-8xl font-black italic text-white tracking-tighter float">COYOTE</h1>
                        <p className="text-indigo-500 font-bold tracking-[0.3em] ml-2">ONLINE PRO</p>
                    </div>

                    <div className="w-full max-w-lg space-y-6">
                        <div className="glass-panel p-6 rounded-3xl space-y-2">
                            <label className="text-[10px] font-black text-slate-500 uppercase flex items-center gap-2">
                                <Icon name="user" size={12} /> あなたの表示名
                            </label>
                            <input className="w-full bg-slate-900/50 border-2 border-slate-800 p-4 rounded-2xl outline-none focus:border-indigo-500 transition-colors font-bold" placeholder="なまえ" value={playerName} onChange={e => setPlayerName(e.target.value)} />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="glass-panel p-6 rounded-[2rem] border-t-4 border-indigo-600 space-y-4">
                                <div className="flex items-center gap-2 text-indigo-400 font-black">
                                    <Icon name="crown" size={20} />
                                    <span>ホストとして遊ぶ</span>
                                </div>
                                <p className="text-xs text-slate-400">新しく部屋を作って、みんなを招待しましょう。</p>
                                <div className="space-y-3">
                                    <select value={maxPlayers} onChange={e => setMaxPlayers(e.target.value)} className="w-full bg-slate-800 border-2 border-slate-700 p-3 rounded-xl font-black outline-none appearance-none cursor-pointer">
                                        {[2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={n}>最大 {n} 名でプレイ</option>)}
                                    </select>
                                    <button onClick={createRoom} className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-black text-white shadow-lg transition-all flex items-center justify-center gap-2">
                                        <Icon name="plus" size={18} /> 部屋を作成
                                    </button>
                                </div>
                            </div>

                            <div className="glass-panel p-6 rounded-[2rem] border-t-4 border-emerald-500 space-y-4">
                                <div className="flex items-center gap-2 text-emerald-400 font-black">
                                    <Icon name="log-in" size={20} />
                                    <span>ゲストとして参加</span>
                                </div>
                                <p className="text-xs text-slate-400">教えてもらったIDを入力して部屋に合流しましょう。</p>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-800 border-2 border-slate-700 p-3 rounded-xl outline-none focus:border-emerald-500 uppercase font-black text-center tracking-widest" placeholder="ID (6桁)" value={roomIdInput} onChange={e => setRoomIdInput(e.target.value)} />
                                    <button onClick={joinRoom} className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-black text-white shadow-lg transition-all flex items-center justify-center gap-2">
                                        参加する
                                    </button>
                                </div>
                            </div>
                        </div>

                        {error && <div className="text-red-400 text-sm font-bold text-center bg-red-400/10 py-3 rounded-xl border border-red-400/20">{error}</div>}

                        <button onClick={() => setShowHelp(true)} className="w-full flex items-center justify-center gap-2 py-3 text-slate-500 font-bold hover:text-white transition-colors">
                            <Icon name="help-circle" size={18} /> 遊び方・ルールを確認
                        </button>
                    </div>

                    {showHelp && (
                        <div className="fixed inset-0 bg-slate-950 z-[500] p-6 overflow-y-auto">
                            <div className="max-w-2xl mx-auto space-y-8">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-3xl font-black italic">HOW TO PLAY</h2>
                                    <button onClick={() => setShowHelp(false)} className="p-2 bg-slate-900 rounded-full"><Icon name="x" /></button>
                                </div>
                                <section className="space-y-4">
                                    <h3 className="text-xl font-bold text-indigo-400">基本ルール</h3>
                                    <p className="text-slate-400 leading-relaxed">自分以外のカードを見て、全員の合計値を予想します。前のプレイヤーより大きい数字を言うか、「コヨーテ！」と宣言して間違いを指摘します。</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-slate-900 p-4 rounded-2xl border border-white/5">
                                            <h4 className="font-bold mb-2 text-indigo-300">コヨーテ成功</h4>
                                            <p className="text-sm text-slate-500">前のプレイヤーが言った数字が合計値を超えていた → <span className="text-red-400">前の人がダメージ</span></p>
                                        </div>
                                        <div className="bg-slate-900 p-4 rounded-2xl border border-white/5">
                                            <h4 className="font-bold mb-2 text-indigo-300">コヨーテ失敗</h4>
                                            <p className="text-sm text-slate-500">前のプレイヤーが言った数字が合計値以下だった → <span className="text-red-400">自分がダメージ</span></p>
                                        </div>
                                    </div>
                                </section>
                                <section className="space-y-4 pb-12">
                                    <h3 className="text-xl font-bold text-indigo-400">特殊カード（計算順序）</h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        <div className="flex gap-4 items-center bg-slate-900 p-3 rounded-xl border border-white/5">
                                            <div className="w-10 h-10 bg-pink-500 rounded flex items-center justify-center font-black">?</div>
                                            <div><div className="font-bold">1. 引き直し</div><div className="text-xs text-slate-500">計算前に山札から新しいカードを引く</div></div>
                                        </div>
                                        <div className="flex gap-4 items-center bg-slate-900 p-3 rounded-xl border border-white/5">
                                            <div className="w-10 h-10 bg-cyan-500 rounded flex items-center justify-center font-black">M0</div>
                                            <div><div className="font-bold">2. 最大値は0</div><div className="text-xs text-slate-500">場の一番大きな数字を0にする</div></div>
                                        </div>
                                        <div className="flex gap-4 items-center bg-slate-900 p-3 rounded-xl border border-white/5">
                                            <div className="w-10 h-10 bg-indigo-500 rounded flex items-center justify-center font-black">×2</div>
                                            <div><div className="font-bold">3. 合計を2倍</div><div className="text-xs text-slate-500">最後に合計値を2倍にする</div></div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </div>
                    )}
                </div>
            );

            const isMyTurn = room.status === 'playing' && room.players[room.currentTurn]?.uid === user.uid;

            return (
                <div className="h-full flex flex-col bg-slate-950">
                    {winner && <Confetti />}

                    <header className="p-4 flex justify-between items-center border-b border-white/5 glass-panel z-50">
                        <div className="flex items-center gap-3">
                            <span className="bg-indigo-600 text-[10px] font-black px-2 py-1 rounded">ROOM</span>
                            <span className="font-black tracking-tighter text-lg">{room.id}</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-1.5 text-slate-500">
                                <Icon name="layers" size={14} />
                                <span className="text-[10px] font-black">{room.deck?.length || 0}</span>
                            </div>
                            <div className="flex items-center gap-1.5 text-slate-500">
                                <Icon name="users" size={14} />
                                <span className="text-[10px] font-black">{room.players.length}/{room.maxPlayers}</span>
                            </div>
                            {/* Wait screen exit button */}
                            {room.status === 'waiting' && (
                                <button onClick={leaveRoom} className="ml-2 p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20 transition-colors">
                                    <Icon name="log-out" size={18} />
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-grow relative overflow-hidden">
                        <div className="absolute inset-0 flex items-start justify-center pt-8 px-4">
                            <div className="flex gap-4 overflow-x-auto no-scrollbar pb-8 w-full justify-center">
                                {room.players.map((p, i) => {
                                    const isMe = p.uid === user.uid;
                                    const isActive = p.hp > 0;
                                    const revealed = room.status === 'result' || (!isMe && isActive) || (isSpectator && isActive);
                                    const isTurn = room.status === 'playing' && room.currentTurn === i;
                                    return (
                                        <div key={p.uid} className={`flex flex-col items-center gap-2 transition-all duration-500 ${!isActive ? 'grayscale opacity-30' : ''} ${isTurn ? 'scale-110' : ''}`}>
                                            <CoyoteCard card={p.currentCard} revealed={revealed} isMe={isMe} />
                                            <div className="text-center">
                                                <div className={`text-[10px] font-black mb-1 truncate w-20 ${isMe ? 'text-indigo-400' : 'text-slate-400'}`}>{p.name}</div>
                                                <div className="flex justify-center gap-1">
                                                    {[...Array(3)].map((_, j) => (
                                                        <div key={j} className={`w-1.5 h-1.5 rounded-full ${j < p.hp ? 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]' : 'bg-slate-800'}`}></div>
                                                    ))}
                                                </div>
                                            </div>
                                            {isTurn && <div className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-ping"></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            {room.status === 'playing' && (
                                <div className="text-center">
                                    <div className="text-[10px] font-black text-indigo-400 tracking-[0.4em] mb-2 uppercase">Current Target</div>
                                    <div className="text-9xl font-black italic text-white drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">{room.currentValue}</div>
                                </div>
                            )}

                            {room.status === 'waiting' && (
                                <div className="bg-slate-900/50 backdrop-blur-xl p-8 rounded-[2rem] border border-white/5 text-center max-w-[320px] shadow-2xl">
                                    <Icon name="clock" size={32} className="mx-auto mb-4 text-indigo-500 animate-pulse" />
                                    <h2 className="text-2xl font-black italic mb-2 uppercase tracking-tighter">Waiting Lobby</h2>
                                    <p className="text-slate-500 text-sm mb-6">他の参加者を待っています。人数が集まったらホストが開始できます。</p>
                                    
                                    <div className="space-y-3">
                                        {room.hostId === user.uid ? (
                                            room.players.length >= 2 ? (
                                                <button onClick={startGame} className="w-full py-4 bg-indigo-600 rounded-2xl font-black text-xl italic hover:scale-105 transition-all shadow-xl flex items-center justify-center gap-2">
                                                    <Icon name="play" size={20} /> GAME START
                                                </button>
                                            ) : (
                                                <div className="py-4 bg-slate-800/50 text-slate-400 rounded-2xl font-bold text-sm border border-white/5">
                                                    あと {2 - room.players.length} 名で開始可能
                                                </div>
                                            )
                                        ) : (
                                            <div className="py-4 bg-indigo-500/10 text-indigo-400 rounded-2xl font-bold border border-indigo-500/20 animate-pulse">
                                                ホストの開始待ち...
                                            </div>
                                        )}
                                        
                                        <button onClick={leaveRoom} className="w-full py-3 text-slate-500 hover:text-white font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                                            <Icon name="arrow-left" size={16} /> 部屋を出てトップに戻る
                                        </button>
                                    </div>
                                </div>
                            )}

                            {room.status === 'result' && !winner && (
                                <div className="bg-white text-slate-950 p-8 rounded-[3rem] w-full max-w-[280px] text-center celebrate-anim shadow-2xl">
                                    <div className="text-[10px] font-black text-slate-400 tracking-widest mb-2 uppercase">Actual Total</div>
                                    <div className="text-7xl font-black italic mb-4 text-indigo-600">{room.lastResult?.total}</div>
                                    <div className="font-bold text-lg mb-6 leading-tight">
                                        {room.lastResult?.loserName}が<br/>ダメージを受けた！
                                    </div>
                                    {room.hostId === user.uid && (
                                        <button onClick={startGame} className="w-full py-4 bg-slate-950 text-white rounded-2xl font-black hover:bg-indigo-600 transition-colors">次へ進む</button>
                                    )}
                                </div>
                            )}
                        </div>

                        {winner && (
                            <div className="absolute inset-0 bg-slate-950/90 z-[300] flex flex-col items-center justify-center p-6 backdrop-blur-xl celebrate-anim">
                                <div className="w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-[0_0_50px_rgba(234,179,8,0.3)]">
                                    <Icon name="trophy" size={48} className="text-white" />
                                </div>
                                <h2 className="text-white text-3xl font-bold mb-2">{winner.name}</h2>
                                <h1 className="text-6xl md:text-8xl font-black text-yellow-500 mb-12 tracking-tighter italic text-center leading-[0.9]">優勝！<br/>おめでとう</h1>
                                <div className="flex flex-col gap-4 w-full max-w-xs">
                                    {room.hostId === user.uid && (
                                        <button onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), { status: 'waiting', players: room.players.map(p => ({...p, hp:3}))})} className="w-full py-5 bg-white text-slate-950 rounded-full font-black text-xl shadow-xl hover:scale-110 active:scale-95 transition-all">もう一度遊ぶ</button>
                                    )}
                                    <button onClick={leaveRoom} className="w-full py-3 text-slate-400 hover:text-white font-bold transition-colors">ロビーを出て終了</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {isMyTurn && !winner && (
                        <footer className="p-6 bg-slate-900/50 backdrop-blur-xl border-t border-white/5">
                            <div className="max-w-md mx-auto grid grid-cols-2 gap-4">
                                <button onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), { currentValue: room.currentValue + 1, currentTurn: (room.currentTurn + 1) % room.players.length })} className="py-5 bg-indigo-600 rounded-3xl font-black text-2xl italic shadow-xl active:scale-95 transition-all">RAISE {room.currentValue + 1}</button>
                                <button onClick={handleCoyote} className="py-5 bg-red-600 rounded-3xl font-black text-2xl italic shadow-xl active:scale-95 transition-all">COYOTE!</button>
                            </div>
                        </footer>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>