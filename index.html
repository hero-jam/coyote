<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Coyote Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .float { animation: float 3s ease-in-out infinite; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 overflow-hidden fixed inset-0">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } = window.firebase;

        const firebaseConfig = {
            apiKey: "AIzaSyCq9rT0N5X7HoCb-OZlBNEtyEAcjuTTDEA",
            authDomain: "hero-tablegames.firebaseapp.com",
            projectId: "hero-tablegames",
            storageBucket: "hero-tablegames.firebasestorage.app",
            messagingSenderId: "674602265882",
            appId: "1:674602265882:web:13b2cbabe692f44c7890a3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "online-coyote-pro-v1";

        const DECK_DEFINITION = [
            { value: -10, count: 1 }, { value: -5, count: 2 }, { value: 0, count: 3 },
            { value: 1, count: 4 }, { value: 2, count: 4 }, { value: 3, count: 4 }, { value: 4, count: 4 },
            { value: 5, count: 4 }, { value: 10, count: 3 }, { value: 15, count: 2 }, { value: 20, count: 1 },
            { type: 'x2', count: 1 }, { type: 'max0', count: 1 }, { type: '?', count: 1 }, { type: 'night', count: 1 }
        ];

        const generateDeck = () => {
            const deck = [];
            DECK_DEFINITION.forEach(item => {
                for (let i = 0; i < item.count; i++) {
                    deck.push({ ...item, id: Math.random().toString(36).substr(2, 9) });
                }
            });
            return deck.sort(() => Math.random() - 0.5);
        };

        const calculateTotal = (cards) => {
            let values = cards.map(c => typeof c.value === 'number' ? c.value : 0);
            const specials = cards.map(c => c.type).filter(Boolean);
            if (specials.includes('max0')) {
                const max = Math.max(...values);
                const idx = values.indexOf(max);
                if (idx > -1) values[idx] = 0;
            }
            let total = values.reduce((a, b) => a + b, 0);
            if (specials.includes('x2')) total *= 2;
            return total;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [room, setRoom] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [roomIdInput, setRoomIdInput] = useState('');
            const [customRoomId, setCustomRoomId] = useState('');
            const [maxPlayers, setMaxPlayers] = useState(4);
            const [declaredValue, setDeclaredValue] = useState(0);
            const [playerName, setPlayerName] = useState('Player');
            const [isEditingName, setIsEditingName] = useState(false);

            // 匿名認証が制限されている場合のローカルUIDフォールバック
            const getFallbackUser = () => {
                let localId = localStorage.getItem('coyote_local_uid');
                if (!localId) {
                    localId = 'temp_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('coyote_local_uid', localId);
                }
                return { uid: localId, isAnonymous: true };
            };

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) { 
                        console.warn("Auth failed, falling back to local ID:", e.message);
                        // 認証エラー時もローカルUIDをセットして続行可能にする
                        setUser(getFallbackUser());
                        setLoading(false);
                    }
                };
                initAuth();
                const unsub = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setPlayerName(prev => prev === 'Player' ? `Player_${u.uid.slice(0, 4)}` : prev);
                        setLoading(false);
                    }
                });
                return () => unsub();
            }, []);

            const isSpectator = useMemo(() => {
                if (!user || !room) return false;
                const me = room.players.find(p => p.uid === user.uid);
                return !me || me.hp <= 0;
            }, [user, room]);

            useEffect(() => {
                if (!user) return;
                const params = new URLSearchParams(window.location.search);
                const rId = params.get('room');
                if (rId) joinRoom(rId);
            }, [user]);

            useEffect(() => {
                if (!user || !room?.id) return;
                const rRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id);
                const unsub = onSnapshot(rRef, (snap) => {
                    if (snap.exists()) setRoom({ id: snap.id, ...snap.data() });
                }, (err) => {
                    console.error("Firestore sync error:", err);
                });
                return () => unsub();
            }, [user, room?.id]);

            const createRoom = async (isRandom = true) => {
                if (!user || isProcessing) return;
                setIsProcessing(true);
                setErrorMessage('');
                
                try {
                    const id = isRandom 
                        ? Math.floor(100000 + Math.random() * 900000).toString() 
                        : customRoomId.trim().toUpperCase();
                    
                    if (!id) {
                        setErrorMessage("IDを入力してください");
                        setIsProcessing(false);
                        return;
                    }

                    const rRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', id);
                    const snap = await getDoc(rRef);
                    
                    if (snap.exists() && snap.data().hostId !== user.uid) {
                        setErrorMessage("そのIDは既に使用されています");
                        setIsProcessing(false);
                        return;
                    }

                    const roomData = {
                        hostId: user.uid,
                        status: 'waiting',
                        maxPlayers: maxPlayers,
                        players: [{ uid: user.uid, name: playerName, hp: 3, isCPU: false }],
                        deck: generateDeck(),
                        currentTurn: 0,
                        currentValue: 0,
                        history: []
                    };
                    await setDoc(rRef, roomData);
                    setRoom({ id, ...roomData });
                } catch (e) {
                    setErrorMessage("ルーム作成に失敗しました。認証設定またはFirestoreのルールを確認してください。");
                    console.error(e);
                } finally {
                    setIsProcessing(false);
                }
            };

            const joinRoom = async (idArg) => {
                const rid = (idArg || roomIdInput).trim().toUpperCase();
                if (!rid || isProcessing || !user) return;
                setIsProcessing(true);
                setErrorMessage('');

                try {
                    const rRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid);
                    const snap = await getDoc(rRef);
                    
                    if (!snap.exists()) {
                        if (!idArg) setErrorMessage("ルームが見つかりません");
                        setIsProcessing(false);
                        return;
                    }
                    
                    const data = snap.data();
                    const players = [...data.players];
                    if (!players.find(p => p.uid === user.uid)) {
                        if (data.status === 'waiting' && players.length < (data.maxPlayers || 8)) {
                            players.push({ uid: user.uid, name: playerName, hp: 3, isCPU: false });
                            await updateDoc(rRef, { players });
                        }
                    }
                    setRoom({ id: rid, ...data, players });
                } catch (e) {
                    setErrorMessage("参加に失敗しました");
                    console.error(e);
                } finally {
                    setIsProcessing(false);
                }
            };

            const startGame = async () => {
                if (isProcessing || !room) return;
                setIsProcessing(true);
                try {
                    let deck = [...room.deck];
                    const activePlayers = room.players.filter(p => p.hp > 0);
                    if (deck.length < activePlayers.length) deck = generateDeck();
                    
                    const players = room.players.map(p => {
                        if (p.hp > 0) {
                            return { ...p, currentCard: deck.pop() };
                        }
                        return { ...p, currentCard: null };
                    });

                    let firstTurn = 0;
                    for (let i = 0; i < players.length; i++) {
                        if (players[i].hp > 0) { firstTurn = i; break; }
                    }

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                        status: 'playing', players, deck, currentTurn: firstTurn, currentValue: 0, lastResult: null
                    });
                } catch (e) {
                    setErrorMessage("ゲーム開始エラー");
                } finally {
                    setIsProcessing(false);
                }
            };

            if (loading) return <div className="h-full flex items-center justify-center bg-slate-950 text-indigo-500 font-black tracking-tighter text-2xl uppercase italic">Loading Coyote...</div>;

            if (!room) return (
                <div className="h-full flex flex-col items-center justify-center p-6 space-y-8 bg-slate-950">
                    <div className="text-center float">
                        <h1 className="text-7xl font-black italic text-white drop-shadow-2xl tracking-tighter">COYOTE</h1>
                        <div className="mt-4 inline-flex items-center gap-2 bg-slate-900 px-4 py-2 rounded-xl border border-slate-800">
                            {isEditingName ? (
                                <input autoFocus className="bg-transparent outline-none text-center w-32 font-bold text-indigo-400" value={playerName} onChange={e => setPlayerName(e.target.value)} onBlur={() => setIsEditingName(false)} />
                            ) : (
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setIsEditingName(true)}>
                                    <span className="font-bold text-slate-400">{playerName}</span>
                                    <Icon name="edit-3" size={14} className="text-indigo-500" />
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="w-full max-w-sm space-y-6">
                        {errorMessage && (
                            <div className="bg-red-500/10 border border-red-500/50 text-red-500 px-4 py-3 rounded-2xl text-xs font-bold flex items-center gap-2 shake">
                                <Icon name="alert-circle" size={16} />
                                {errorMessage}
                            </div>
                        )}

                        <div className="space-y-4 bg-slate-900/40 p-5 rounded-[2.5rem] border border-slate-800">
                            <div className="space-y-2">
                                <p className="text-[10px] font-black text-slate-500 px-2 uppercase tracking-widest">Max Players: {maxPlayers}</p>
                                <input type="range" min="2" max="8" value={maxPlayers} onChange={e => setMaxPlayers(parseInt(e.target.value))} className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                            </div>
                            
                            <div className="bg-slate-900/50 p-2 rounded-3xl border border-slate-800 focus-within:border-indigo-500 transition-colors flex items-center">
                                <input 
                                    placeholder="好きなIDを入力" 
                                    className="flex-grow bg-transparent border-none py-3 px-4 font-bold text-lg outline-none placeholder:text-slate-700"
                                    value={customRoomId}
                                    onChange={e => { setCustomRoomId(e.target.value); setErrorMessage(''); }}
                                />
                                <button 
                                    disabled={isProcessing}
                                    onClick={() => createRoom(false)} 
                                    className={`px-6 py-3 rounded-2xl font-black text-sm transition-all ${isProcessing ? 'bg-slate-800 text-slate-600' : 'bg-indigo-600 text-white active:scale-95'}`}
                                >
                                    作成
                                </button>
                            </div>
                            <button 
                                disabled={isProcessing}
                                onClick={() => createRoom(true)} 
                                className="w-full py-3 bg-slate-800 rounded-2xl font-bold text-slate-300 border border-slate-700 active:scale-95 transition-all disabled:opacity-50 text-sm"
                            >
                                ランダムIDで作成
                            </button>
                        </div>

                        <div className="relative flex items-center py-2">
                            <div className="flex-grow border-t border-slate-800"></div>
                            <span className="px-4 text-[10px] font-black text-slate-700 uppercase">Join Room</span>
                            <div className="flex-grow border-t border-slate-800"></div>
                        </div>

                        <div className="bg-slate-900/50 p-2 rounded-3xl border border-slate-800 focus-within:border-white transition-colors flex items-center">
                            <input 
                                placeholder="IDを入力" 
                                className="flex-grow bg-transparent border-none py-3 px-4 font-mono text-lg tracking-widest outline-none placeholder:text-slate-700 uppercase"
                                value={roomIdInput}
                                onChange={e => { setRoomIdInput(e.target.value); setErrorMessage(''); }}
                            />
                            <button 
                                disabled={isProcessing}
                                onClick={() => joinRoom()} 
                                className={`p-3 rounded-full transition-all ${isProcessing ? 'bg-slate-800 text-slate-600' : 'bg-white text-slate-950 active:scale-90'}`}
                            >
                                <Icon name="arrow-right" />
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="h-full flex flex-col bg-slate-950 overflow-hidden">
                    <header className="p-4 flex justify-between items-center bg-slate-900/50 backdrop-blur-md border-b border-slate-800">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center font-black">C</div>
                            <div>
                                <p className="text-[10px] font-black text-slate-500 leading-none">ROOM ID: <span className="text-indigo-400 uppercase">{room.id}</span></p>
                                <p className="text-[10px] font-bold text-slate-600 uppercase">{room.players.length}/{room.maxPlayers || 8} PLAYERS</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => {
                                const currentUrl = new URL(window.location.href);
                                currentUrl.searchParams.set('room', room.id);
                                const copyText = currentUrl.toString();
                                const el = document.createElement('textarea');
                                el.value = copyText;
                                document.body.appendChild(el);
                                el.select();
                                try { document.execCommand('copy'); } catch(e) {}
                                document.body.removeChild(el);
                                
                                setErrorMessage('招待URLをコピーしました！');
                                setTimeout(() => setErrorMessage(''), 2000);
                            }} className="p-2 bg-slate-800 rounded-full text-slate-400 flex items-center gap-2 px-4 active:scale-95 transition-all">
                                <Icon name="share-2" size={16} />
                                <span className="text-xs font-bold">招待</span>
                            </button>
                            <button onClick={() => { setRoom(null); setErrorMessage(''); }} className="p-2 bg-red-900/20 text-red-500 rounded-full px-4 text-xs font-bold">退室</button>
                        </div>
                    </header>
                    
                    <main className="flex-grow relative flex flex-col items-center justify-center">
                        <div className="text-center z-10">
                            <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">
                                {room.status === 'playing' ? `${room.players[room.currentTurn]?.name} のターン` : '待機中...'}
                            </p>
                            <div className="text-9xl font-black italic text-white drop-shadow-2xl">{room.currentValue}</div>
                        </div>

                        {room.status === 'waiting' && (
                            <div className="absolute bottom-10 w-full max-w-xs px-6">
                                {room.hostId === user.uid ? (
                                    <button 
                                        disabled={isProcessing || room.players.length < 2}
                                        onClick={startGame} 
                                        className="w-full py-5 bg-indigo-600 rounded-[2rem] font-black text-xl italic shadow-2xl active:scale-95 transition-all disabled:opacity-50"
                                    >
                                        START GAME
                                    </button>
                                ) : (
                                    <div className="text-center py-5 bg-slate-900/50 rounded-[2rem] border border-slate-800 font-bold text-slate-500 animate-pulse">
                                        ホストを待っています
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="absolute top-10 flex gap-4 overflow-x-auto w-full px-10 no-scrollbar justify-center">
                            {room.players.map(p => {
                                const canSeeCard = isSpectator || room.status === 'result' || p.uid !== user.uid;
                                
                                return (
                                    <div key={p.uid} className={`flex flex-col items-center gap-2 shrink-0 transition-opacity ${p.hp <= 0 ? 'opacity-40' : 'opacity-100'}`}>
                                        <div className={`w-14 h-20 rounded-xl border-2 flex items-center justify-center transition-all ${p.uid === user.uid ? 'bg-indigo-600 border-indigo-400 shadow-[0_0_15px_rgba(79,70,229,0.5)]' : 'bg-white text-slate-950 border-white'}`}>
                                            <span className={`text-xl font-black italic ${isSpectator && p.hp > 0 ? 'text-indigo-600' : ''}`}>
                                                { (canSeeCard && p.currentCard) ? (p.currentCard.value ?? p.currentCard.type ?? '?') : (p.hp > 0 ? '?' : '-') }
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            {Array.from({length: 3}).map((_, i) => (
                                                <div key={i} className={`w-1.5 h-1.5 rounded-full ${i < p.hp ? 'bg-red-500' : 'bg-slate-800'}`}></div>
                                            ))}
                                        </div>
                                        <span className={`text-[10px] font-black ${p.uid === user.uid ? 'text-indigo-400' : 'text-slate-500'}`}>{p.name}</span>
                                    </div>
                                );
                            })}
                        </div>

                        {room.status === 'playing' && room.players[room.currentTurn]?.uid === user.uid && !isSpectator && (
                             <div className="absolute bottom-10 w-full max-w-sm px-6 space-y-4">
                                <div className="bg-slate-900 border border-slate-800 p-4 rounded-3xl flex justify-between items-center shadow-2xl">
                                    <button onClick={() => setDeclaredValue(v => Math.max(room.currentValue + 1, (v || room.currentValue + 1) - 1))} className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center active:bg-slate-700"><Icon name="minus" /></button>
                                    <span className="text-5xl font-black italic text-white">{declaredValue || room.currentValue + 1}</span>
                                    <button onClick={() => setDeclaredValue(v => Math.max(room.currentValue + 1, (v || room.currentValue + 1) + 1))} className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center active:bg-slate-700"><Icon name="plus" /></button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={async () => {
                                        const v = declaredValue || room.currentValue + 1;
                                        let nextTurn = (room.currentTurn + 1) % room.players.length;
                                        while(room.players[nextTurn].hp <= 0) {
                                            nextTurn = (nextTurn + 1) % room.players.length;
                                        }
                                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                                            currentValue: v,
                                            currentTurn: nextTurn
                                        });
                                        setDeclaredValue(0);
                                    }} className="py-5 bg-indigo-600 rounded-2xl font-black italic text-xl shadow-lg active:scale-95 transition-all">RAISE</button>
                                    <button onClick={async () => {
                                        const activePlayersCards = room.players.filter(p => p.hp > 0).map(p => p.currentCard);
                                        const total = calculateTotal(activePlayersCards);
                                        const isSuccess = room.currentValue > total;
                                        
                                        let prevTurn = (room.currentTurn - 1 + room.players.length) % room.players.length;
                                        while(room.players[prevTurn].hp <= 0) {
                                            prevTurn = (prevTurn - 1 + room.players.length) % room.players.length;
                                        }
                                        
                                        const loserIdx = isSuccess ? prevTurn : room.currentTurn;
                                        const newPlayers = room.players.map((p, i) => i === loserIdx ? { ...p, hp: p.hp - 1 } : p);
                                        
                                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', room.id), {
                                            status: 'result',
                                            lastResult: { total, loserName: room.players[loserIdx].name, success: isSuccess },
                                            players: newPlayers
                                        });
                                    }} className="py-5 bg-red-600 rounded-2xl font-black italic text-xl shadow-lg active:scale-95 transition-all">COYOTE!</button>
                                </div>
                             </div>
                        )}

                        {room.status === 'result' && (
                            <div className="absolute inset-0 bg-slate-950/95 flex items-center justify-center p-6 z-[200] backdrop-blur-sm">
                                <div className="bg-white text-slate-950 p-8 rounded-[3rem] w-full max-w-xs text-center shadow-[0_0_50px_rgba(255,255,255,0.2)]">
                                    <p className="font-black text-slate-400 text-xs tracking-widest uppercase">The Total Was</p>
                                    <h2 className="text-8xl font-black italic my-4 text-indigo-600">{room.lastResult?.total}</h2>
                                    <div className={`inline-block px-4 py-1 rounded-full text-[10px] font-black uppercase mb-4 ${room.lastResult?.success ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {room.lastResult?.success ? 'Coyote Success!' : 'Coyote Failed...'}
                                    </div>
                                    <p className="font-bold text-lg mb-6 leading-tight">{room.lastResult?.loserName} <br/><span className="text-sm opacity-50 text-red-600 italic">LOST 1 LIFE</span></p>
                                    {room.hostId === user.uid && (
                                        <button onClick={startGame} className="w-full py-4 bg-slate-950 text-white rounded-2xl font-black italic text-lg hover:bg-indigo-600 transition-colors">NEXT ROUND</button>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>